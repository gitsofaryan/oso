# Tests for int_artifacts_by_project_in_opendevdata
# Validates artifact_source_id COALESCE: OSSD > gharchive

test_int_artifacts_by_project_in_opendevdata_ossd_fallback:
  # When int_artifacts__github has no match but int_repositories__ossd does,
  # artifact_source_id should come from OSSD
  model: oso.int_artifacts_by_project_in_opendevdata
  inputs:
    oso.int_repos_by_ecosystem_in_opendevdata:
      rows:
        - repo_link: "https://github.com/testorg/testrepo"
          ecosystem_name: "Test Ecosystem"
          distance: 0
    oso.int_artifacts__github:
      rows: []
    oso.int_repositories__ossd:
      rows:
        - artifact_source_id: "ossd_id_123"
          artifact_namespace: "testorg"
          artifact_name: "testrepo"
  outputs:
    query:
      partial: true
      rows:
        - artifact_source_id: "ossd_id_123"
          artifact_namespace: "testorg"
          artifact_name: "testrepo"

test_int_artifacts_by_project_in_opendevdata_gharchive_only:
  # When only int_artifacts__github has the ID, use it
  model: oso.int_artifacts_by_project_in_opendevdata
  inputs:
    oso.int_repos_by_ecosystem_in_opendevdata:
      rows:
        - repo_link: "https://github.com/orgA/repoA"
          ecosystem_name: "Eco A"
          distance: 0
    oso.int_artifacts__github:
      rows:
        - artifact_source_id: "gharchive_id_456"
          artifact_id: "aid_456"
          artifact_namespace: "orgA"
          artifact_name: "repoA"
          artifact_type: "REPOSITORY"
          artifact_url: "https://github.com/orgA/repoA"
    oso.int_repositories__ossd:
      columns:
        artifact_source_id: varchar
        artifact_namespace: varchar
        artifact_name: varchar
      rows: []
  outputs:
    query:
      partial: true
      rows:
        - artifact_source_id: "gharchive_id_456"
          artifact_namespace: "orga"
          artifact_name: "repoa"

test_int_artifacts_by_project_in_opendevdata_ossd_preferred:
  # When both sources have a match, OSSD takes priority
  model: oso.int_artifacts_by_project_in_opendevdata
  inputs:
    oso.int_repos_by_ecosystem_in_opendevdata:
      rows:
        - repo_link: "https://github.com/bothorg/bothrepo"
          ecosystem_name: "Both Eco"
          distance: 0
    oso.int_artifacts__github:
      rows:
        - artifact_source_id: "gharchive_id_789"
          artifact_id: "aid_789"
          artifact_namespace: "bothorg"
          artifact_name: "bothrepo"
          artifact_type: "REPOSITORY"
          artifact_url: "https://github.com/bothorg/bothrepo"
    oso.int_repositories__ossd:
      rows:
        - artifact_source_id: "ossd_id_789"
          artifact_namespace: "bothorg"
          artifact_name: "bothrepo"
  outputs:
    query:
      partial: true
      rows:
        - artifact_source_id: "ossd_id_789"
          artifact_namespace: "bothorg"
          artifact_name: "bothrepo"
